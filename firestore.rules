rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Collective Mood: Anyone can read, only authenticated users can update.
    match /appState/collectiveMood {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // User Activity: Authenticated users can write their own heartbeat.
    match /userActivity/{userId} {
      allow read: if true; // Allow reading for user count estimations
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Mood Snapshots (History): Read-only for clients.
    match /moodSnapshots/{snapshotId} {
      allow read: if true;
      allow write: if false; // Snapshots are created by a trusted server process (or via archive function)
    }
    
    // Community Quotes:
    match /communityQuotes/{quoteId} {
      // Anyone can read quotes
      allow read: if true;
      
      // Authenticated users can create quotes and update likes
      allow create: if request.auth != null;
      allow update: if request.auth != null && ('likes' in request.resource.data);
    }
    
    // Typing users: Authenticated users can set/delete their own status
    match /typingUsers/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Personal User Mood History
    match /userMoodHistory/{userId}/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User Profiles (for streaks)
    match /userProfiles/{userId} {
       allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
