rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // The single document holding the collective mood state
    match /appState/collectiveMood {
      // Anyone can read the current collective mood.
      allow read: if true;
      // Only authenticated users can write to update the mood.
      allow write: if request.auth != null;
    }

    // User-specific data, like personal mood history
    match /userMoodHistory/{userId}/{document=**} {
      // A user can only read and write to their own history path.
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // User profiles, including streak data
    match /userProfiles/{userId} {
      // A user can only read and write their own profile.
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Anonymous thoughts submitted by users
    match /communityQuotes/{quoteId} {
      // Anyone can read the thoughts.
      allow read: if true;
      // Authenticated users can create new thoughts.
      allow create: if request.auth != null;
      // Authenticated users can update documents, but only to increment likes.
      allow update: if request.auth != null &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes']);
    }

    // Historical data for the trend chart
    match /moodSnapshots/{snapshotId} {
      // Anyone can read the historical data.
      allow read: if true;
      // Any authenticated user can trigger an archive process (create a snapshot).
      allow create: if request.auth != null;
    }

    // Tracks which users are currently active
    match /userActivity/{userId} {
      // Authenticated users can update their own activity status.
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Tracks which users are currently typing a thought
    match /typingUsers/{userId} {
      // Anyone can see who is typing.
      allow read: if true;
      // Authenticated users can set/delete their own typing status.
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
